<!DOCTYPE html>
<html lang="it">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>ottimizzazione logistica</title>
        <style>
            table,
            th,
            td {
                border: 1px solid rgb(0, 0, 0);
                border-collapse: collapse;
            }
            .container {
                display: inline-block;
                padding: 1rem;
                border: 1px solid rgb(0, 0, 0);
                vertical-align: top;
            }
        </style>
    </head>
    <body>
        <script>
            function scriviTabella(tabella, element, id = "f") {
                const elemento = document.getElementById(element);
                let testo = "";
                testo += "<table id ='" + id + "'><tr><th></th>";
                for (let j = 0; j < tabella[0].length - 1; j++) {
                    testo += "<th>D" + (j + 1) + "</th>";
                }
                testo += "<th>TOT</th>";
                testo += "</tr>";
                for (let i = 0; i < tabella.length; i++) {
                    if (i + 1 == tabella.length) {
                        testo += "<tr><th>TOT</th>";
                    } else {
                        testo += "<tr><th>UP" + (i + 1) + "</th>";
                    }
                    for (let j = 0; j < tabella[0].length; j++) {
                        testo += "<td>" + tabella[i][j] + "</td>";
                    }
                    testo += "</tr>";
                }
                testo += "</table>";
                elemento.innerHTML = testo;
                //document.body.appendChild(elemento);
            }

            function scriviReport(report, element) {
                const elemento = document.getElementById(element);
                let testo = "";
                let Qtot = 0;
                let Ctot = 0;
                let tabella = copiaMatrice(report);
                testo +=
                    "<table><tr><th>Quantita'</th><th>Movimento da =>a</th><th>costo</th></tr><tr>";
                for (let i = 0; i < tabella.length; i++) {
                    for (let j = 0; j < tabella[0].length; j++) {
                        testo += "<td>" + tabella[i][j] + "</td>";
                        switch (j) {
                            case 0:
                                Qtot += tabella[i][j];
                                break;
                            case 2:
                                Ctot += tabella[i][j];
                                break;
                        }
                    }
                    testo += "</tr>";
                }
                testo +=
                    "<tr><td>" +
                    Qtot +
                    "</td><td></td><td>" +
                    Ctot +
                    "</td></tr>";
                testo += "</table>";
                elemento.innerHTML = testo;
                //document.body.appendChild(elemento);
            }

            function copiaMatrice(matrice) {
                let copia = [];
                for (let i = 0; i < matrice.length; i++) {
                    copia[i] = [...matrice[i]];
                }
                return copia;
            }

            function nordOvest(tabella, element) {
                let table = copiaMatrice(tabella);
                let ultimaRiga = table.pop();
                let tot = ultimaRiga.pop();
                let ultimaColonna = [];
                for (i = 0; i < table.length; i++) {
                    ultimaColonna[i] = table[i].pop();
                }
                console.log(ultimaRiga);
                console.log(ultimaColonna);
                console.log(table);
                let costoTot = 0;
                let riassunto = [];
                let UP = 1;
                let D = 1;
                do {
                    let costoParziale = 0;
                    let quantita = 0;
                    if (ultimaColonna[0] > ultimaRiga[0]) {
                        //modifico il valore maggiore
                        ultimaColonna[0] -= ultimaRiga[0];

                        //inizializzo i valori per creare il riassunto
                        quantita = ultimaRiga[0];
                        costoParziale += table[0][0] * quantita;

                        //cancello la colonna
                        ultimaRiga.shift();
                        for (i = 0; i < table.length; i++) {
                            table[i].shift();
                        }
                        //creo la riga del riassunto
                        riassunto[riassunto.length] = [
                            quantita,
                            "UP" + UP + "=>D" + D,
                            costoParziale,
                        ];

                        UP++; //"sposto" la riga
                    } else if (ultimaRiga[0] > ultimaColonna[0]) {
                        //modifico il valore maggiore
                        ultimaRiga[0] -= ultimaColonna[0];

                        //inizializzo i valori per creare il riassunto
                        quantita = ultimaColonna[0];
                        costoParziale += table[0][0] * quantita;

                        //cancello la riga
                        ultimaColonna.shift();
                        table.shift();

                        //creo la riga del riassunto
                        riassunto[riassunto.length] = [
                            quantita,
                            "UP" + UP + "=>D" + D,
                            costoParziale,
                        ];

                        D++; //"sposto" la colonna
                    } else if (ultimaColonna[0] == ultimaRiga[0]) {
                        //inizializzo i valori per creare il riassunto
                        quantita = ultimaColonna[0];
                        costoParziale += table[0][0] * quantita;

                        //cancello la colonna e la riga
                        ultimaColonna.shift();
                        table.shift();
                        ultimaRiga.shift();
                        for (i = 0; i < table.length; i++) {
                            table[i].shift();
                        }

                        //creo la riga del riassunto
                        riassunto[riassunto.length] = [
                            quantita,
                            "UP" + UP + "=>D" + D,
                            costoParziale,
                        ];

                        UP++;
                        D++;
                    }
                    costoTot += costoParziale; //aggiorno il costo totale

                    console.log(copiaMatrice(table));
                } while (table.length * table[0]?.length > 0);
                console.log(riassunto);
                scriviReport(riassunto, element);
            }

            function minimiCosti(tabella, element) {
                let table = copiaMatrice(tabella);
                let ultimaRiga = table.pop();
                let tot = ultimaRiga.pop();
                let ultimaColonna = [];
                for (i = 0; i < table.length; i++) {
                    ultimaColonna[i] = table[i].pop();
                }
                console.log(ultimaRiga);
                console.log(ultimaColonna);
                console.log(table);
                let costoTot = 0;
                let riassunto = [];
                let UP = [];
                for (let i = 0; i < table.length; i++) {
                    UP[i] = i + 1;
                }
                let D = [];
                for (let i = 0; i < table[0].length; i++) {
                    D[i] = i + 1;
                }
                let uPr;
                let dest;
                do {
                    let costoParziale = 0;
                    let quantita = 0;
                    let temp = [];
                    let min = 0;
                    let riga;
                    for (let i = 0; i < table.length; i++) {
                        temp[i] = Math.min(...table[i]);
                        min = Math.min(...temp);
                        riga = temp.indexOf(min);
                        colonna = table[riga].indexOf(min);
                    }

                    if (ultimaColonna[riga] > ultimaRiga[colonna]) {
                        //modifico il valore maggiore
                        ultimaColonna[riga] -= ultimaRiga[colonna];

                        //inizializzo i valori per creare il riassunto
                        quantita = ultimaRiga[colonna];
                        costoParziale += table[riga][colonna] * quantita;

                        //cancello la colonna
                        ultimaRiga.splice(colonna, 1);
                        dest = D.splice(colonna, 1);
                        uPr = UP[riga];
                        for (i = 0; i < table.length; i++) {
                            table[i].splice(colonna, 1);
                        }
                    } else if (ultimaRiga[colonna] > ultimaColonna[riga]) {
                        //modifico il valore maggiore
                        ultimaRiga[colonna] -= ultimaColonna[riga];

                        //inizializzo i valori per creare il riassunto
                        quantita = ultimaColonna[riga];
                        costoParziale += table[riga][colonna] * quantita;

                        //cancello la riga
                        ultimaColonna.splice(riga, 1);
                        uPr = UP.splice(riga, 1);
                        desr = D[colonna];
                        table.splice(riga, 1);
                    } else if (ultimaRiga[colonna] == ultimaColonna[riga]) {
                        //inizializzo i valori per creare il riassunto
                        quantita = ultimaColonna[riga];
                        costoParziale += table[riga][colonna] * quantita;

                        //cancello la riga e la colonna
                        ultimaRiga.splice(colonna, 1);
                        ultimaColonna.splice(riga, 1);
                        dest = D.splice(colonna, 1);
                        uPr = UP.splice(riga, 1);
                        for (i = 0; i < table.length; i++) {
                            table[i].splice(colonna, 1);
                        }
                        table.splice(riga, 1);
                    }
                    riassunto[riassunto.length] = [
                        quantita,
                        "UP" + uPr + "=>D" + dest,
                        costoParziale,
                    ];

                    console.log(copiaMatrice(table));
                } while (table.length * table[0]?.length > 0);
                console.log(riassunto);
                scriviReport(riassunto, element);
            }

            function aggiungiRiga(tabella, totO, totV) {
                let ultimaRiga = tabella.pop();
                let nuovaRiga = [];
                for (let i = 0; i < ultimaRiga.length - 1; i++) {
                    nuovaRiga[i] = 999;
                }
                nuovaRiga[nuovaRiga.length] = totO - totV;
                tabella.push(nuovaRiga);
                tabella.push(ultimaRiga);
            }

            function aggiungiColonna(tabella, totO, totV) {
                for (i = 0; i < tabella.length; i++) {
                    let temp = tabella[i][tabella[i].length - 1];
                    tabella[i][tabella[i].length - 1] = 999;
                    tabella[i][tabella[i].length] = temp;
                }
                tabella[tabella.length - 1][
                    tabella[tabella.length - 1].length - 2
                ] = totV - totO;
            }

            function elaboraTabella(tabella) {
                let totV = 0;
                for (i = 0; i < tabella.length - 1; i++) {
                    totV += tabella[i][tabella[i].length - 1];
                }

                console.log("totV = " + totV + "<br/>");

                let totO = 0;
                for (i = 0; i < tabella[0].length - 1; i++) {
                    totO += tabella[tabella.length - 1][i];
                }

                console.log("totO = " + totO + "<br/>");

                if (totO > totV) {
                    console.log(
                        "i totali non coincidono<br/>e' stata aggiunta una unita' produttiva fittizia<br/>"
                    );
                    aggiungiRiga(tabella, totO, totV);
                    tot = totO;
                } else if (totV > totO) {
                    console.log(
                        "i totali non coincidono<br/>e' stata aggiunta una destinazione fittizia<br/>"
                    );
                    aggiungiColonna(tabella, totO, totV);
                    tot = totV;
                } else tot = totV;

                tabella[tabella.length - 1][tabella[0].length - 1] = tot;
                console.log("il totale e' " + tot + "<br/>");
                console.log(tabella);
            }

            function inserisciTabella(element) {
                const elemento = document.getElementById(element);
                let w = document.getElementById("w").value;
                let h = document.getElementById("h").value;
                if (w) {
                    w++;
                } else {
                    elemento.innerHTML =
                        "inserisci un valore valido per la larghezza";
                    return 1;
                }
                if (h) {
                    h++;
                } else {
                    elemento.innerHTML =
                        "inserisci un valore valido per l'altezza";
                    return 1;
                }
                let tabella = [];
                for (let i = 0; i < h; i++) {
                    tabella[i] = [];
                    for (let j = 0; j < w; j++) {
                        let max = 100;
                        if (i == h - 1 || j == w - 1) {
                            max = 666;
                        }
                        tabella[i][j] =
                            '<input type="number" id="' +
                            i +
                            "|" +
                            j +
                            '" name="' +
                            i +
                            "|" +
                            j +
                            '" min="1" max="' +
                            max +
                            '" />';
                    }
                }
                scriviTabella(tabella, element, "roberto");
                document.getElementById("roberto").innerHTML +=
                    '<button onclick="ottieniValori(' +
                    "'mario'" +
                    ')">elabora</button>';
            }

            function ottieniValori(element) {
                const elemento = document.getElementById(element);
                let w = document.getElementById("w").value;
                let h = document.getElementById("h").value;
                let tabella = [];
                for (let i = 0; i <= h; i++) {
                    tabella[i] = [];
                    for (let j = 0; j <= w; j++) {
                        tabella[i][j] =
                            1 * document.getElementById(i + "|" + j).value;
                    }
                }
                elaboraTabella(tabella);
                scriviTabella(tabella, element, "roberto");
                table = tabella;
                console.log(table);
            }

            var tot = 0;
            var table = [];
            /*let tabella = [
                [80, 40, 20, 90, 50],
                [150, 130, 5, 30, 200],
                [40, 40, 10, 100, 300],
                [50, 100, 200, 200, 0],
            ];
            elaboraTabella(tabella);*/
        </script>
        <p>
            larghezza tabella (numero destinazioni):
            <input type="number" id="w" name="w" min="2" max="100" value="2" />
        </p>
        <p>
            altezza tabella (numero unit√† produttive):
            <input type="number" id="h" name="h" min="2" max="100" value="2" />
        </p>
        <div class="container">
            <button onclick="inserisciTabella('mario')">
                inserisci manualmente
            </button>
            <p id="mario"></p>
        </div>
        <div class="container">
            <button onclick="generaTabella('carlo')">genera casualmente</button>
            <p id="carlo"></p>
        </div>
        <!--<div>
            <button onclick="scriviTabella(tabella,'tabellaOut')">
                genera tabella
            </button>
            <p id="tabellaOut"></p>
        </div>-->
        <br />
        <div class="container">
            <button onclick="nordOvest(table,'giorgio')">
                metodo nord ovest
            </button>
            <p id="giorgio"></p>
        </div>
        <div class="container">
            <button onclick="minimiCosti(table,'fabio')">
                metodo dei minimi costi
            </button>
            <p id="fabio"></p>
        </div>
    </body>
</html>
